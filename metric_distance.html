<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محاسبه فاصله در فضاهای متریک</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <style>
    body { font-family: Tahoma, sans-serif; margin: 20px; background: #eef2f7; text-align: center; }
    #controls { margin-bottom: 20px; background: white; padding: 18px; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: inline-block; }
    select, button { padding: 12px 16px; margin: 8px; font-size: 17px; border-radius: 10px; border: 1px solid #ddd; }
    button { background: #007bff; color: white; cursor: pointer; border: none; }
    button:hover { background: #0056b3; }
    #info { margin-top: 20px; background: white; padding: 20px; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: inline-block; min-width: 500px; font-size: 18px; }
    canvas { border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 20px; }
  </style>
</head>
<body>
  <h1>محاسبه فاصله در فضاهای متریک</h1>
  
  <div id="controls">
    <label>بعد فضا:</label>
    <select id="dimension">
      <option value="2">۲ بعدی</option>
      <option value="3" selected>۳ بعدی</option>
    </select>
    
    <label>متریک:</label>
    <select id="metric">
      <option value="euclidean">اقلیدسی</option>
      <option value="manhattan">منهتن</option>
      <option value="chebyshev">ماکسیمم (Chebyshev)</option>
      <option value="discrete">گسسته</option>
    </select>
    
    <button id="reset">شروع دوباره</button>
  </div>
  
  <div id="info">روی صفحه کلیک کنید تا نقطه اول را انتخاب کنید.</div>

  <script>
    let points = [];
    let dim = 3;
    let metric = 'euclidean';

    function setup() {
      createCanvas(900, 700, WEBGL);
      
      select('#dimension').changed(() => {
        dim = int(select('#dimension').value());
        points = [];
        updateInfo();
      });

      select('#metric').changed(() => {
        metric = select('#metric').value();
        updateInfo();
      });

      select('#reset').mousePressed(() => {
        points = [];
        updateInfo();
      });
    }

    function draw() {
      background(240, 248, 255);

      ambientLight(120);
      directionalLight(255, 255, 255, -0.5, 0.5, -1);

      if (dim === 3) {
        orbitControl(1, 1, 0); // فقط چرخش و پن
        rotateY(-0.45);  // زاویه استاندارد isometric با جهت مثبت محورها
        rotateX(0.3);

        // grid floor برای عمق
        stroke(180, 200, 255, 120);
        strokeWeight(1);
        let gridSize = 400;
        let step = 50;
        for (let i = -gridSize; i <= gridSize; i += step) {
          line(i, 0, -gridSize, i, 0, gridSize);
          line(-gridSize, 0, i, gridSize, 0, i);
        }

        // محورها
        drawAxis(350, color(230, 60, 60), "X");
        drawAxis(350, color(60, 200, 60), "Y", 'y');
        drawAxis(350, color(60, 120, 230), "Z", 'z');
      } else {
        // حالت ۲ بعدی (دقیق و زیبا)
        ortho(-width/2, width/2, height/2, -height/2);
        camera(0, 0, 800, 0, 0, 0, 0, 1, 0);

        stroke(220);
        strokeWeight(1);
        for (let i = -400; i <= 400; i += 50) {
          line(i, -350, 0, i, 350, 0);
          line(-450, i, 0, 450, i, 0);
        }

        strokeWeight(4);
        stroke(80);
        line(-450, 0, 0, 450, 0, 0);
        line(0, -350, 0, 0, 350, 0);

        fill(80);
        noStroke();
        textSize(18);
        text("X", 460, 10);
        text("Y", 0, -360);
      }

      // نقاط
      points.forEach((p, i) => {
        push();
        translate(p.x, p.y, p.z || 0);
        noStroke();
        fill(i === 0 ? color(230, 70, 70) : color(70, 130, 230));
        sphere(16);
        pop();
      });

      // مسیرها
      if (points.length === 2) {
        let a = points[0];
        let b = points[1];

        if (metric === 'euclidean') {
          stroke(80, 140, 255);
          strokeWeight(6);
          line(a.x, a.y, a.z||0, b.x, b.y, b.z||0);
        } else if (metric === 'manhattan') {
          drawAxisPath(a, b, color(70, 210, 110, 240));
        } else if (metric === 'chebyshev') {
          drawChebyshevPath(a, b);
        }
      }

      updateInfo();
    }

    function drawAxis(len, col, label, axis = 'x') {
      stroke(col);
      strokeWeight(7);
      let ex = axis === 'x' ? len : 0;
      let ey = axis === 'y' ? len : 0;
      let ez = axis === 'z' ? len : 0;
      line(0, 0, 0, ex, ey, ez);

      // برچسب
      push();
      translate(ex * 1.15, ey * 1.15, ez * 1.15);
      fill(col);
      noStroke();
      textSize(30);
      textAlign(CENTER, CENTER);
      text(label, 0, 0);
      pop();
    }

    function drawAxisPath(a, b, col) {
      stroke(col);
      strokeWeight(5);
      let current = {x: a.x, y: a.y, z: a.z || 0};
      let order = ['x', 'y', 'z'].filter(a => dim === 2 ? a !== 'z' : true);
      for (let ax of order) {
        let next = {...current};
        if (ax === 'x') next.x = b.x;
        if (ax === 'y') next.y = b.y;
        if (ax === 'z') next.z = b.z;
        line(current.x, current.y, current.z, next.x, next.y, next.z);
        current = next;
      }
    }

    function drawChebyshevPath(a, b) {
      let diffs = [
        {axis: 'x', val: abs(b.x - a.x)},
        {axis: 'y', val: abs(b.y - a.y)},
        {axis: 'z', val: dim === 3 ? abs(b.z - a.z) : 0}
      ].filter(d => d.val > 0.01 && (dim === 2 ? d.axis !== 'z' : true));

      diffs.sort((p,q) => q.val - p.val);
      let maxAxis = diffs[0]?.axis;

      let current = {x: a.x, y: a.y, z: a.z || 0};
      for (let d of diffs) {
        let next = {...current};
        if (d.axis === 'x') next.x = b.x;
        if (d.axis === 'y') next.y = b.y;
        if (d.axis === 'z') next.z = b.z;

        if (d.axis === maxAxis) {
          stroke(255, 80, 80);
          strokeWeight(8);
        } else {
          stroke(255, 170, 90, 220);
          strokeWeight(5);
        }
        line(current.x, current.y, current.z, next.x, next.y, next.z);
        current = next;
      }
    }

    function mousePressed() {
      if (mouseX < 0 || mouseX > width || mouseY < 0 || mouseY > height) return;

      // map دقیق برای همخوانی کامل کلیک با موقعیت
      let x = map(mouseX, 0, width, -300, 300);
      let y = map(mouseY, 0, height, 250, -250); // y معکوس برای طبیعی بودن
      let z = dim === 3 ? 0 : 0;

      if (points.length < 2) {
        points.push({x, y, z});
      } else {
        points[0] = {x, y, z};
      }
    }

    function calculateDistance(a, b) {
      if (metric === 'discrete') return (abs(a.x-b.x)<1 && abs(a.y-b.y)<1 && (dim===2 || abs(a.z-b.z)<1)) ? 0 : 1;

      let dx = abs(a.x - b.x);
      let dy = abs(a.y - b.y);
      let dz = dim === 3 ? abs(a.z - b.z) : 0;

      if (metric === 'euclidean') return sqrt(dx*dx + dy*dy + dz*dz);
      if (metric === 'manhattan') return dx + dy + dz;
      if (metric === 'chebyshev') return max(dx, dy, dz);
    }

    function updateInfo() {
      let info = document.getElementById('info');
      if (points.length < 2) {
        info.innerHTML = points.length === 0 
          ? '<p style="color:#555; font-size:18px;">روی صفحه کلیک کنید تا نقطه اول را انتخاب کنید.</p>'
          : `<p><strong>نقطه اول:</strong> (${points[0].x.toFixed(1)}, ${points[0].y.toFixed(1)}${dim===3?', '+points[0].z.toFixed(1):''})</p>
             <p style="color:#007bff;">حالا نقطه دوم را انتخاب کنید.</p>`;
        return;
      }

      let a = points[0], b = points[1];
      let dist = calculateDistance(a, b).toFixed(4);

      let names = {euclidean:'اقلیدسی', manhattan:'منهتن', chebyshev:'ماکسیمم (Chebyshev)', discrete:'گسسته'};
      let formulas = {
        euclidean: '√(Δx² + Δy²' + (dim===3?' + Δz²':'') + ')',
        manhattan: '|Δx| + |Δy|' + (dim===3?' + |Δz|':''),
        chebyshev: 'max(|Δx|, |Δy|' + (dim===3?', |Δz|':'') + ')',
        discrete: '۰ اگر یکسان، ۱ در غیر این صورت'
      };

      info.innerHTML = `
        <p><strong>نقطه A:</strong> (${a.x.toFixed(1)}, ${a.y.toFixed(1)}${dim===3?', '+a.z.toFixed(1):''})</p>
        <p><strong>نقطه B:</strong> (${b.x.toFixed(1)}, ${b.y.toFixed(1)}${dim===3?', '+b.z.toFixed(1):''})</p>
        <p><strong>فاصله (${names[metric]}):</strong> <span style="font-size:2.2em; color:#e74c3c; font-weight:bold;">${dist}</span></p>
        <p><strong>فرمول:</strong> d = ${formulas[metric]}</p>
      `;
    }
  </script>
</body>
</html>